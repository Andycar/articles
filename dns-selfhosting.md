## Настраиваем собственный сервер DNS с шифрованием

Технология DNS (Domain Name System, система доменных имён) используется нами
ежедневно, и сегодня невозможно представить существование Интернета без этой
системы. DNS используется, чтобы преобразовать человекочитаемый адрес сайта,
который легко запомнить: causa-arcana.com в машиночитаемый адрес, по которому
компьютер может получить (или отправить) требуемую информацию - IP-адрес:
178.62.217.225

Эта технология была разработана в 1983 году, когда вопросы безопасности, защиты
личных данных и противодействия цензуре не стояли так остро, как сегодня. По
этой причине технология DNS подвержена различным атакам, а передаваемые по сети
данные - запрос и ответ - не зашифрованы и доступны всем участникам сети: вашему
роутеру, интернет-провайдеру и даже злоумышленнику, подключившемуся к бесплатной
сети Wi-Fi в кафе вместе с вами.

В этой статье мы расскажем, как зашифровать DNS запросы и ответы, используя для
этого собственный сервер, и обеспечить защиту от атак, использующих уязвимости в
протоколе DNS. Для шифрования и аутентификации DNS сегодня используются два
стандарта: DNS-over-TLS (DNS поверх TLS) и DNS-over-HTTPS (DNS поверх HTTPS).
Первый из них подвержен блокировке со стороны провайдера или государства,
поскольку использует конкретный сетевой порт, а второй работает поверх HTTPS
соединения, и заблокировать его технически сложнее. Различные устройства и
программное обеспечение поддерживают различные стандарты, поэтому наш сервер
будет поддерживать оба.

> Важно: использование DNS-over-TLS (далее: DoT) или DNS-over-HTTPS (далее: DoH)
> не обеспечивает анонимность в Интернете, не защищает от слежки со стороны
> государства или участников сети и, в большинстве случаев, не предоставляет
> возможности посещать заблокированные ресурсы.

Тогда зачем это нужно? Использование DoT или DoH:

- защищает от атак с перехватом и манипулированием данными

---

Когда-нибудь встречались с такой ситуацией: вы ошиблись в адресе сайта и попали
на страничку с рекламой? Или попытались зайти на заблокированный ресурс и попали
на страничку интернет-провайдера с соответствующим сообщением? В этих случаях вы
сталкивались с перехватом DNS и подменой ответа - вместо запрошенного вами сайта
вы попали на другой, и это самые безобидные способы использования уязвимостей
DNS.

--- 

- усложняет отслеживание вашей активности в сети вашим интернет-провайдером и
  другими участниками сети

Но почему бы не использовать бесплатный сервис DoT / DoH, предоставляемый такими
компаниями как Google, Cloudflare, OpenDNS или одной из компаний, в цели которой
входит защита ваших данных - AdGuard, NextDNS, Quad9?

- используя сторонний сервис, вы предоставляете ему некоторую информацию о себе:
  IP-адреса ваших устройств и ваше примерное расположение, чаще всего с
  точностью до города

- ни один из перечисленных сервисов не предоставляет возможности самостоятельно
  заблокировать любое количество адресов в Интернете с целью защиты от
  мошеннических сайтов, а также слежки и рекламы в сети

Если есть VPN, то зачем нужен собственный DNS-сервер? Не всех пользователей
беспокоят блокировки в Интернете и интересует полное шифрование данных,
проходящих через интернет-провайдера. Некоторые сайты могут работать (или
отображать цены в рублях) только при наличии российского IP. У многих из нас
есть родственники, которым мы можем предоставить базовый уровень безопасности в
Интернете и частичную защиту от слежки и рекламы без рисков и неудобств,
связанных с использованием VPN.

## Итак, вы решили настроить собственный DoT, DoH сервер? Тогда начнём!

### Установка и настройка DNS-сервера

Если вы арендуете виртуальный сервер впервые, обязательно ознакомьтесь со
статьёй, в которой мы подробно описываем
[первоначальную настройку](https://causa-arcana.com/blog/2021/11/10/server-administration.html).
Если же у вас уже есть опыт администрирования сервера, статья поможет
проверить, что сервер достаточно защищён. Также вам понадобится доменное имя.

В качестве DNS-сервера мы будем использовать [CoreDNS](https://coredns.io) -
многофункциональный DNS-сервер с открытым кодом, не требовательный к ресурсам,
который подходит как для личного использования, так и для серьёзных нагрузок в
корпоративных сетях.

На момент написания этой статьи актуальная версия CoreDNS - 1.8.6. При установке
обязательно уточните текущую версию на сайте проекта и скорректируйте команды.
Скачаем архив с исполняемым файлом, распакуем его и поместим файл в
соответствующую директорию, после чего изменим владельца файла на `root`:

```
$ wget https://github.com/coredns/coredns/releases/download/v1.8.6/coredns_1.8.6_linux_amd64.tgz
$ tar -zxvf coredns_1.8.6_linux_amd64.tgz
$ sudo mv coredns /usr/bin/
$ sudo chown root:root /usr/bin/coredns
```

Разрешим исполняемому файлу использовать порты с номерами ниже 1024, поскольку
DoT и DoH используют порты 853 и 443 соответственно:

```
$ sudo setcap CAP_NET_BIND_SERVICE=+eip /usr/bin/coredns
```

В целях безопасности создадим отдельного пользователя для CoreDNS, чтобы не
запускать процесс от пользователя `root`:

```
$ sudo adduser --system --disabled-password --disabled-login --home /var/lib/coredns --group coredns
```

Нам также потребуется Unit-файл для автозапуска сервиса. С содержимым файла
можно ознакомиться по
[этой ссылке](https://github.com/coredns/deployment/blob/master/debian/coredns.service).
Загрузим его сразу в необходимую директорию:

```
$ sudo wget https://raw.githubusercontent.com/coredns/deployment/master/debian/coredns.service -O /lib/systemd/system/coredns.service
```

Теперь нам необходимо определиться с адресом, по которому будет доступен DoT /
DoH сервер. Для этих целей рекомендуем использовать поддомен, поскольку основной
домен может вам пригодиться для создания собственного сайта или настройки
другого посещаемого сервиса. Для целей данной статьи мы будем использовать
поддомен `ds`, а домен будет изменён на `example.org` в целях
конфиденциальности, как и IP-адрес сервера.

В настройках DNS регистратора доменных имён добавим запись типа A, указывающую
на наш сервер, и запись типа TXT, указывающую, что с этого поддомена рассылка
электронных писем производиться не может:

```
Type        Host(name)          Value
A Record    ds                  46.101.128.1
TXT Record  ds                  v=spf1 -all
```

На сервере установим `certbot`, чтобы получить сертификат Let's Encrypt и
использовать его для DNS-сервера, и запросим сертификат:

```
$ sudo apt install certbot
$ sudo certbot -d ds.example.org --manual --preferred-challenges dns certonly
```

Следуя инструкциям в терминале, предоставим адрес электронной почты для важных
уведомлений, в том числе об истечении срока действия сертификата, ознакомимся и
согласимся с условиями использования сертификата, и ответим на вопрос о согласии
на прочую рассылку. Следующая инструкция - подтвердить, что поддомен
`ds.example.org` принадлежит нам. Для этого необходимо добавить проверочную
запись в настройках DNS регистратора доменных имён следующего вида, где X -
предоставленное `certbot` значение:

```
Type        Host(name)          Value
TXT Record  _acme-challenge.ds  X
```

Сертификат действует 90 дней, до окончания этого срока его необходимо обновить.
Инструкции по обновлению сертификата будут приведены ниже в этой статье.

Следующим шагом создадим конфигурационный файл CoreDNS и директорию для него.

```
$ sudo mkdir /etc/coredns
$ sudo nano /etc/coredns/Coredns
```

Содержимое файла (вставить текст в терминал можно сочетанием **Ctrl + Shift + V**):

```
#DoH
https://.:443 {
    tls /etc/letsencrypt/live/ds.example.org/fullchain.pem /etc/letsencrypt/live/ds.example.org/privkey.pem
    cache 60
    # log
    # errors
    hosts /opt/hosts {
      fallthrough
    }
    forward . tls://9.9.9.10 tls://149.112.112.10 {
      tls_servername dns10.quad9.net
      health_check 5s
    }
}

#DoT
tls://.:853 {
    tls /etc/letsencrypt/live/ds.example.org/fullchain.pem /etc/letsencrypt/live/ds.example.org/privkey.pem
    cache 60
    # log
    # errors
    hosts /opt/hosts {
      fallthrough
    }
    forward . tls://9.9.9.10 tls://149.112.112.10 {
      tls_servername dns10.quad9.net
      health_check 5s
    }
}
```

Опции `log` и `errors` закомментированы, чтобы не сохранять в логах сервера
чувствительную информацию. При возникновении проблем с сервером опции можно
включить в целях отладки, перезапустить сервис `coredns` и наблюдать за
системным журналом в режиме реального времени с помощью команды `journalctl
-f`.

В конфигурационном файле используются адреса DNS-сервера Quad9, вы можете
использовать любой приглянувшийся сервер или не полагаться на централизованный
сервис и настроить Unbound.

`/opt/hosts` - путь к файлу, в который можно добавлять собственные списки
блокировки в следующем формате:

```
0.0.0.0 adservice.google.com
```

Сейчас этого файла не существует, создадим его, чтобы избежать ошибок:

```
$ sudo touch /opt/hosts
```

Позже вы можете наполнить этот файл, используя, например, репозиторий
[spyware-hosts](https://gitlab.com/nobodysu/spyware-hosts), который содержит в
том числе российские домены, и/или списки, используемые по умолчанию в проекте
Pi-hole:

```
https://raw.githubusercontent.com/StevenBlack/hosts/master/hosts
https://sysctl.org/cameleon/hosts
https://s3.amazonaws.com/lists.disconnect.me/simple_tracking.txt
https://s3.amazonaws.com/lists.disconnect.me/simple_ad.txt
```

У пользователя `coredns` отсутствует доступ к сертификатам Let's Encrypt,
поэтому сервис сейчас запустить не получится. Установим утилиту `acl` и
предоставим такой доступ:

```
$ sudo apt install acl
$ sudo setfacl -m u:coredns:r-X /etc/letsencrypt/live
$ sudo setfacl -m u:coredns:r-X /etc/letsencrypt/live/ds.example.org
$ sudo setfacl -m u:coredns:r /etc/letsencrypt/live/ds.example.org/fullchain.pem
$ sudo setfacl -m u:coredns:r /etc/letsencrypt/live/ds.example.org/privkey.pem
$ sudo setfacl -m u:coredns:r-X /etc/letsencrypt/archive/
$ sudo setfacl -m u:coredns:r-X /etc/letsencrypt/archive/ds.example.org
$ sudo setfacl -m u:coredns:r /etc/letsencrypt/archive/ds.example.org/fullchain1.pem
$ sudo setfacl -m u:coredns:r /etc/letsencrypt/archive/ds.example.org/privkey1.pem
```

Мы почти готовы запустить DNS-сервер, но сначала необходимо настроить файрвол,
чтобы защитить сервер от злоумышленников, которые могли бы использовать его,
например, для
[некоторых видов DDoS атак](https://www.cloudflare.com/learning/ddos/dns-amplification-ddos-attack/).

Настроим доступ к DNS-серверу. Узнайте публичный IP-адрес вашего устройства и
получите полный диапазон адресов, в который входит ваш адрес, следующей
командой, подставив IP-адрес устройства:

```
$ whois 83.220.232.1
```

В ответе будет строка с диапазоном адресов вроде: `83.220.232.0 -
83.220.235.255`. Используя [один из онлайн-сервисов](https://ip2cidr.com/), мы
конвертируем этот диапазон в CIDR: `83.220.232.0/22`, и откроем для диапазона
доступ к портам 443 и 853 нашего сервера. Ниже приведены команды для
рекомендованного нами UFW:

```
$ sudo ufw allow from 83.220.232.0/22 to any port 443 comment "DoH range 1"
$ sudo ufw allow from 83.220.232.0/22 to any port 853 comment "DoT range 1"
```

Запустим DNS-сервер командой:

```
$ sudo systemctl enable --now coredns
```

Проверить работу сервера можно в браузере по адресу
`https://ds.example.org/dns-query` - при корректной настройке будет
установлено зашифрованное соединение и вы увидите ответ:
`no 'dns' query parameter found`.

В будущем для обновления сертификата Let's Encrypt необходимо повторить
команду, которая использовалась при получении сертификата:
`sudo certbot -d ds.example.org --manual --preferred-challenges dns certonly`
и следовать инструкциям в терминале. После успешного обновления сертификата
необходимо повторно выдать разрешения пользователю `coredns` и перезапустить
сервис:

```
$ sudo setfacl -m u:coredns:r-X /etc/letsencrypt/live
$ sudo setfacl -m u:coredns:r-X /etc/letsencrypt/live/ds.example.org
$ sudo setfacl -m u:coredns:r /etc/letsencrypt/live/ds.example.org/fullchain.pem
$ sudo setfacl -m u:coredns:r /etc/letsencrypt/live/ds.example.org/privkey.pem
$ sudo setfacl -m u:coredns:r-X /etc/letsencrypt/archive/
$ sudo setfacl -m u:coredns:r-X /etc/letsencrypt/archive/ds.example.org
$ sudo setfacl -m u:coredns:r /etc/letsencrypt/archive/ds.example.org/fullchain1.pem
$ sudo setfacl -m u:coredns:r /etc/letsencrypt/archive/ds.example.org/privkey1.pem
$ sudo systemctl restart coredns
```

## Настройка клиентов

Для настройки DoH или DoT на смартфоне с ОС Android 5.0 и выше используйте
приложение Nebulo, для настройки DoH на iOS - приложение DNSCloak. Для настройки
DoH в браузере Firefox ознакомьтесь с
[официальной инструкцией](https://support.mozilla.org/ru/kb/dns-cherez-https-v-firefox#w_vkliuchenie-i-otkliuchenie-dns-cherez-https-vruchnuiu).
Поддержка DoH на уровне ОС заявлена в Windows 11, но на момент написания этой
статьи нами не тестировалась. Помимо этого, DoT поддерживают некоторые роутеры.

Далее мы детально опишем настройку DoT на ПК с ОС Debian 11. В качестве клиента
будет использоваться сервис `systemd-resolved`. С помощью команды `systemctl
status systemd-resolved` вы можете убедиться, что этот сервис присутствует в
системе, но не активен - это видно в строке `Active: inactive (dead)`. Если у
вас Ubuntu 21.10 или более поздняя версия, этот сервис будет активен по
умолчанию, и часть приведённых здесь инструкций следует пропустить. В Ubuntu
20.04 `systemd-resolved` активен, но не работает с DoT.

Отредактируем файл `/etc/systemd/resolved.conf` следующим образом:

```
[Resolve]
DNS=46.101.128.1#ds.example.org
FallbackDNS=
#Domains=
DNSSEC=yes
DNSOverTLS=yes
#MulticastDNS=yes
#LLMNR=yes
#Cache=yes
#DNSStubListener=yes
#DNSStubListenerExtra=
#ReadEtcHosts=yes
#ResolveUnicastSingleLabel=no
```

Включим `systemd-resolved` и убедимся, что сервис корректно отвечает на запросы
(предварительно установите пакет `dnsutils`):

```
$ sudo systemctl enable --now systemd-resolved
$ dig @127.0.0.53 causa-arcana.com
```

В ответе, помимо прочей информации, должен присутствовать IP-адрес сайта.

В Debian 11 настройки DNS определяются сервисом `NetworkManager`(это указано в
первой строке файла `/etc/resolv.conf`), и эту настройку необходимо изменить.
Создайте файл `/etc/NetworkManager/conf.d/99-dns.conf` со следующим содержимым:

```
[main]
dns=none
```

Перезапустите сервис:

```
$ sudo systemctl restart NetworkManager
```

Теперь укажите в файле `/etc/resolv.conf` только тот адрес, по которому доступен
`systemd-resolved`:

```
nameserver 127.0.0.53
```

Настройка DNS на Debian завершена.
